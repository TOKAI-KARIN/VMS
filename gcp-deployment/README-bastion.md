# GCPè¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ + ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹æ§‹æˆ

ã“ã®æ§‹æˆã§ã¯ã€GCPã®VMã‚’è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ï¼ˆãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ï¼‰ã¨ã—ã¦åˆ©ç”¨ã—ã€ãƒ¡ã‚¤ãƒ³ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ã§å‹•ä½œã•ã›ã¾ã™ã€‚

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ
    â†“
GCP VM (è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼)
    â†“ (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚· + SSLçµ‚ç«¯)
ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼
    â†“
React App (ãƒãƒ¼ãƒˆ3000) + Node.js API (ãƒãƒ¼ãƒˆ3001)
    â†“
PostgreSQL (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)
```

## âœ¨ ã“ã®æ§‹æˆã®ãƒ¡ãƒªãƒƒãƒˆ

### ğŸ’° **ã‚³ã‚¹ãƒˆåŠ¹ç‡**
- **GCPè¸ã¿å°ã‚µãƒ¼ãƒãƒ¼**: æœˆé¡ç´„$5-8 (e2-micro)
- **ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼**: æ—¢å­˜ã‚µãƒ¼ãƒãƒ¼ã‚’æ´»ç”¨ï¼ˆè¿½åŠ ã‚³ã‚¹ãƒˆãªã—ï¼‰
- **åˆè¨ˆ**: æœˆé¡ç´„$5-8

### ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
- ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ã¯ç›´æ¥ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã•ã‚Œãªã„
- GCPè¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ã§SSLçµ‚ç«¯
- ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

### ğŸš€ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
- ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ã®å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’æ´»ç”¨
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä½é…å»¶ã‚¢ã‚¯ã‚»ã‚¹
- é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥

### ğŸ”§ **é‹ç”¨æ€§**
- ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ã§ã®ç›´æ¥ç®¡ç†
- ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨ãªåˆ¶å¾¡
- æ—¢å­˜ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ´»ç”¨

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
gcp-deployment/
â”œâ”€â”€ nginx-reverse-proxy.conf    # ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·è¨­å®š
â”œâ”€â”€ setup-bastion-only.sh       # è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼å°‚ç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
â”œâ”€â”€ onpremise-setup-guide.md    # ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰
â”œâ”€â”€ firewall-rules.sh           # GCPãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š
â”œâ”€â”€ update-ssl.sh               # SSLè¨¼æ˜æ›¸è‡ªå‹•æ›´æ–°
â”œâ”€â”€ backup.sh                   # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ monitoring.sh               # ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ setup-cron.sh               # å®šæœŸã‚¿ã‚¹ã‚¯è¨­å®š
â””â”€â”€ README-bastion.md           # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ã®æº–å‚™

```bash
# ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œ
# è©³ç´°ã¯ onpremise-setup-guide.md ã‚’å‚ç…§
```

### 2. GCPè¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ã®ä½œæˆ

```bash
# GCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¾ãŸã¯gcloud CLIã§VMã‚’ä½œæˆ
gcloud compute instances create bastion-server \
    --zone=asia-northeast1-a \
    --machine-type=e2-micro \
    --image-family=ubuntu-2004-lts \
    --image-project=ubuntu-os-cloud \
    --tags=http-server,https-server \
    --network-interface=network-tier=PREMIUM,subnet=default
```

### 3. è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# SSHã§GCP VMã«æ¥ç¶š
gcloud compute ssh bastion-server

# è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
wget https://raw.githubusercontent.com/yourusername/vehicle-management/main/gcp-deployment/setup-bastion-only.sh
chmod +x setup-bastion-only.sh

# è¨­å®šã‚’ç·¨é›†
nano setup-bastion-only.sh
# DOMAIN_NAME="your-domain.com"
# ONPREMISE_IP="YOUR_ONPREMISE_IP"

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
./setup-bastion-only.sh
```

### 4. DNSè¨­å®š

ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ä»¥ä¸‹ã®DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šï¼š

```
A ãƒ¬ã‚³ãƒ¼ãƒ‰: your-domain.com â†’ GCP VMã®å¤–éƒ¨IP
A ãƒ¬ã‚³ãƒ¼ãƒ‰: www.your-domain.com â†’ GCP VMã®å¤–éƒ¨IP
```

## ğŸ”§ è¨­å®šé …ç›®

### å¿…é ˆè¨­å®š

1. **ãƒ‰ãƒ¡ã‚¤ãƒ³å**: `your-domain.com`
2. **ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼IP**: `YOUR_ONPREMISE_IP`
3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**: `your-secure-password`
4. **JWTã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**: `your-jwt-secret-key-here`

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š

- **ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼**: 3000, 3001ãƒãƒ¼ãƒˆã‚’å†…éƒ¨é–‹æ”¾
- **GCPè¸ã¿å°ã‚µãƒ¼ãƒãƒ¼**: 80, 443ãƒãƒ¼ãƒˆã‚’å¤–éƒ¨é–‹æ”¾
- **ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«**: å¿…è¦æœ€å°é™ã®ãƒãƒ¼ãƒˆã®ã¿é–‹æ”¾

## ğŸ“Š ç›£è¦–ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼

```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
pm2 status
pm2 logs

# ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª
htop
df -h
free -h

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª
sudo -u postgres psql -c "\l"
```

### è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼

```bash
# ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ç›£è¦–
tail -f /var/log/bastion/onpremise-monitor.log

# Nginxãƒ­ã‚°
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# SSLè¨¼æ˜æ›¸ç¢ºèª
sudo certbot certificates
```

## ğŸ”„ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
cd /var/www/vehicle-management
git pull origin main

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ“ãƒ«ãƒ‰
cd client && npm install && npm run build

# ã‚µãƒ¼ãƒãƒ¼ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
cd ../server && npm install

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å†èµ·å‹•
cd .. && pm2 restart all
```

## ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ããªã„**
   ```bash
   # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šç¢ºèª
   ping YOUR_ONPREMISE_IP
   telnet YOUR_ONPREMISE_IP 3000
   telnet YOUR_ONPREMISE_IP 3001
   ```

2. **SSLè¨¼æ˜æ›¸ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼**
   ```bash
   # è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œ
   sudo certbot renew --dry-run
   ```

3. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ãªã„**
   ```bash
   # ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œ
   pm2 logs
   pm2 restart all
   ```

## ğŸ’° ã‚³ã‚¹ãƒˆæ¯”è¼ƒ

| æ§‹æˆ | æœˆé¡ã‚³ã‚¹ãƒˆ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|------|------------|----------|------------|
| **GCPè¸ã¿å° + ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹** | $5-8 | ä½ã‚³ã‚¹ãƒˆã€ãƒ‡ãƒ¼ã‚¿åˆ¶å¾¡ | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¾å­˜ |
| **GCPå®Œå…¨ç§»è¡Œ** | $25-35 | é«˜å¯ç”¨æ€§ã€ç®¡ç†å®¹æ˜“ | é«˜ã‚³ã‚¹ãƒˆ |
| **ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç›´æ¥å…¬é–‹** | $0 | æœ€ä½ã‚³ã‚¹ãƒˆ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ |

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼
- ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§å¿…è¦æœ€å°é™ã®ãƒãƒ¼ãƒˆã®ã¿é–‹æ”¾
- å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
- å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°

### è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼
- SSLè¨¼æ˜æ›¸ã«ã‚ˆã‚‹æš—å·åŒ–
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®š
- ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã®ç›£è¦–

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
- VPNæ¥ç¶šã®æ¤œè¨
- IPåˆ¶é™ã®è¨­å®š
- ä¾µå…¥æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. **ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚µãƒ¼ãƒãƒ¼**: `pm2 logs`
2. **è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼**: `/var/log/bastion/onpremise-monitor.log`
3. **Nginxãƒ­ã‚°**: `/var/log/nginx/`

## ğŸ”„ æ›´æ–°ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### å®šæœŸçš„ãªãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

```bash
# ã‚·ã‚¹ãƒ†ãƒ ã®æ›´æ–°
sudo apt update && sudo apt upgrade -y

# SSLè¨¼æ˜æ›¸ã®æ›´æ–°ç¢ºèª
sudo certbot renew --dry-run

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
sudo logrotate -f /etc/logrotate.d/bastion-server
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
pg_dump vehicle_management > backup_$(date +%Y%m%d).sql

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
tar -czf app_backup_$(date +%Y%m%d).tar.gz /var/www/vehicle-management
``` 