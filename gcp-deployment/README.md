# GCP VM ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€GCPã®VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦åˆ©ç”¨ã—ã¦Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“‹ å‰ææ¡ä»¶

1. **GCPã‚¢ã‚«ã‚¦ãƒ³ãƒˆ** - Google Cloud Platformã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå¿…è¦ã§ã™
2. **ãƒ‰ãƒ¡ã‚¤ãƒ³å** - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆä¾‹ï¼š`your-app.com`ï¼‰
3. **GitHubãƒªãƒã‚¸ãƒˆãƒª** - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒGitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹ã“ã¨

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. GCP VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ

1. **GCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«**ã«ã‚¢ã‚¯ã‚»ã‚¹
2. **Compute Engine** â†’ **VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹** â†’ **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ**
3. ä»¥ä¸‹ã®è¨­å®šã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆï¼š
   - **åå‰**: `vehicle-management-server`
   - **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: `asia-northeast1` (æ±äº¬)
   - **ãƒã‚·ãƒ³ã‚¿ã‚¤ãƒ—**: `e2-medium` (2 vCPU, 4 GB ãƒ¡ãƒ¢ãƒª)
   - **ãƒ–ãƒ¼ãƒˆãƒ‡ã‚£ã‚¹ã‚¯**: Ubuntu 20.04 LTS
   - **ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«**: HTTPã€HTTPSãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’è¨±å¯

### 2. ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è¨­å®š

1. **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**ã§DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šï¼š
   ```
   A ãƒ¬ã‚³ãƒ¼ãƒ‰: your-domain.com â†’ GCP VMã®å¤–éƒ¨IP
   A ãƒ¬ã‚³ãƒ¼ãƒ‰: www.your-domain.com â†’ GCP VMã®å¤–éƒ¨IP
   ```

### 3. VMã¸ã®æ¥ç¶šã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# SSHã§VMã«æ¥ç¶š
gcloud compute ssh vehicle-management-server

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
wget https://raw.githubusercontent.com/yourusername/vehicle-management/main/gcp-deployment/setup-gcp-vm.sh

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç·¨é›†ï¼ˆè¨­å®šã‚’å¤‰æ›´ï¼‰
nano setup-gcp-vm.sh

# å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸ã—ã¦å®Ÿè¡Œ
chmod +x setup-gcp-vm.sh
./setup-gcp-vm.sh
```

### 4. è¨­å®šã®å¤‰æ›´

ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®ä»¥ä¸‹ã®å¤‰æ•°ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼š

```bash
DOMAIN_NAME="your-domain.com"           # ã‚ãªãŸã®ãƒ‰ãƒ¡ã‚¤ãƒ³å
DB_PASSWORD="your-secure-password"      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
GITHUB_REPO="https://github.com/yourusername/vehicle-management.git"  # GitHubãƒªãƒã‚¸ãƒˆãƒªURL
```

## ğŸ”§ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ
    â†“
GCP VM (è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼)
    â†“
Nginx (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚· + SSLçµ‚ç«¯)
    â†“
React App (ãƒãƒ¼ãƒˆ3000) + Node.js API (ãƒãƒ¼ãƒˆ3001)
    â†“
PostgreSQL (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)
```

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
gcp-deployment/
â”œâ”€â”€ nginx.conf              # Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ ecosystem.config.js      # PM2è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ setup-gcp-vm.sh         # åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ deploy.sh               # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â””â”€â”€ README.md               # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## ğŸ”„ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# VMã«SSHæ¥ç¶š
gcloud compute ssh vehicle-management-server

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
./setup-gcp-vm.sh
```

### ç¶™ç¶šçš„ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# VMã«SSHæ¥ç¶š
gcloud compute ssh vehicle-management-server

# ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
cd /var/www/vehicle-management
./gcp-deployment/deploy.sh
```

## ğŸ“Š ç›£è¦–ã¨ãƒ­ã‚°

### PM2ã‚³ãƒãƒ³ãƒ‰

```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
pm2 status

# ãƒ­ã‚°ã®ç¢ºèª
pm2 logs

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å†èµ·å‹•
pm2 restart all

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åœæ­¢
pm2 stop all
```

### ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°

```bash
# Nginxãƒ­ã‚°
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# PM2ãƒ­ã‚°
tail -f /var/log/pm2/client-out.log
tail -f /var/log/pm2/server-out.log
```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

### ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«

- ãƒãƒ¼ãƒˆ22 (SSH): è¨±å¯
- ãƒãƒ¼ãƒˆ80 (HTTP): è¨±å¯
- ãƒãƒ¼ãƒˆ443 (HTTPS): è¨±å¯
- ãã®ä»–ã®ãƒãƒ¼ãƒˆ: æ‹’å¦

### SSLè¨¼æ˜æ›¸

- Let's Encryptã«ã‚ˆã‚‹è‡ªå‹•SSLè¨¼æ˜æ›¸å–å¾—
- 90æ—¥ã”ã¨ã®è‡ªå‹•æ›´æ–°

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

- PostgreSQLã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆã®ã¿ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨

## ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ãªã„**
   ```bash
   pm2 logs
   pm2 restart all
   ```

2. **SSLè¨¼æ˜æ›¸ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼**
   ```bash
   sudo certbot renew --dry-run
   ```

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼**
   ```bash
   sudo systemctl status postgresql
   sudo -u postgres psql -c "\l"
   ```

4. **Nginxè¨­å®šã‚¨ãƒ©ãƒ¼**
   ```bash
   sudo nginx -t
   sudo systemctl restart nginx
   ```

## ğŸ’° ã‚³ã‚¹ãƒˆæœ€é©åŒ–

### æ¨å¥¨è¨­å®š

- **ãƒã‚·ãƒ³ã‚¿ã‚¤ãƒ—**: e2-medium (æœˆé¡ç´„$25)
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: æ¨™æº–æ°¸ç¶šãƒ‡ã‚£ã‚¹ã‚¯ 20GB
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: æ¨™æº–ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

### ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãƒ’ãƒ³ãƒˆ

1. **é–‹ç™ºç’°å¢ƒ**ã§ã¯e2-microã‚’ä½¿ç”¨
2. **è‡ªå‹•åœæ­¢**æ©Ÿèƒ½ã‚’æ´»ç”¨
3. **ãƒ—ãƒªã‚¨ãƒ³ãƒ—ãƒ†ã‚£ãƒ–ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**ã‚’æ¤œè¨

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. PM2ãƒ­ã‚°: `pm2 logs`
2. Nginxãƒ­ã‚°: `/var/log/nginx/`
3. ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°: `journalctl -u nginx`

## ğŸ”„ æ›´æ–°ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### å®šæœŸçš„ãªãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

```bash
# ã‚·ã‚¹ãƒ†ãƒ ã®æ›´æ–°
sudo apt update && sudo apt upgrade -y

# SSLè¨¼æ˜æ›¸ã®æ›´æ–°ç¢ºèª
sudo certbot renew --dry-run

# PM2ã®æ›´æ–°
npm install -g pm2@latest
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
pg_dump vehicle_management > backup_$(date +%Y%m%d).sql

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
tar -czf app_backup_$(date +%Y%m%d).tar.gz /var/www/vehicle-management
``` 